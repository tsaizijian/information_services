# 使用者管理功能說明

## 📋 功能概述

管理員可以透過使用者管理頁面來管理系統中所有使用者的角色權限，包括將使用者升級為「照顧者」或「管理員」。

## 🎯 頁面路由

- **路徑**: `/users`
- **權限**: 僅限 `admin` 角色存取
- **檔案位置**: `/frontend/pages/users/index.vue`

## 🔐 角色權限說明

### 1. 家屬 (family)

- 👤 預設註冊角色
- ✅ 查看相關個案資料
- ✅ 查看個案照護紀錄
- ✅ 查看生命徵象紀錄
- ✅ 接收通知訊息
- ❌ 無法管理班級或其他個案

### 2. 照顧者 (caregiver)

- 👨‍⚕️ 需由管理員設定
- ✅ 管理班級與個案資料
- ✅ 新增、編輯照護紀錄
- ✅ 查看班級統計數據
- ✅ 匯出個案報表
- ❌ 無法管理使用者帳號

### 3. 管理員 (admin)

- 👑 最高權限
- ✅ 管理所有使用者帳號
- ✅ 管理所有班級與個案
- ✅ 新增、編輯、刪除所有照護紀錄
- ✅ 查看所有統計數據與報表
- ✅ 系統設定與配置

## 📊 頁面功能

### 統計卡片

顯示三種角色的使用者數量：

- 管理員數量（藍色）
- 照顧者數量（綠色）
- 家屬數量（紫色）

### 搜尋與篩選

- **搜尋**: 可依姓名或 Email 搜尋
- **角色篩選**: 全部角色 / 管理員 / 照顧者 / 家屬
- **狀態篩選**: 全部狀態 / 啟用 / 停用

### 使用者列表

顯示所有使用者資訊：

- 姓名與頭像（角色顏色標示）
- Email 信箱
- 電話號碼
- 角色標籤（帶圖示）
- 帳號狀態（啟用/停用）
- 註冊時間
- 操作按鈕

### 操作功能

#### 1. 編輯角色

- 點擊「編輯」按鈕
- 彈出對話框顯示使用者資訊
- 選擇新角色（管理員/照顧者/家屬）
- 顯示角色權限說明
- 變更警告提示
- 確認後立即生效

#### 2. 啟用/停用帳號

- 點擊「啟用/停用」按鈕
- 停用後使用者無法登入
- 啟用後恢復登入權限

## 🔧 技術實作

### 資料結構

```typescript
interface User {
  userId: string; // 使用者 ID
  email: string; // Email 信箱
  displayName: string; // 顯示名稱
  phone?: string; // 電話號碼（選填）
  role: "admin" | "caregiver" | "family"; // 角色
  isActive: boolean; // 帳號狀態
  createdAt: any; // 建立時間
  updatedAt: any; // 更新時間
}
```

### Firestore 規則

```javascript
// users/{userId}
allow read: if isAuthenticated();
allow update: if isAdmin(); // 管理員可以更新所有欄位（包括 role）
allow delete: if isAdmin();
```

### Composables

- `useAuth()` - 使用者認證
- `useFirestore()` - Firestore CRUD 操作
  - `getCollection()` - 取得所有使用者
  - `updateDocument()` - 更新使用者角色/狀態

## 📱 UI 組件

使用 PrimeVue 組件：

- `Card` - 卡片容器
- `DataTable` - 使用者列表表格
- `Dialog` - 編輯角色對話框
- `Select` - 下拉選單（角色選擇、篩選）
- `InputText` - 搜尋輸入框
- `Button` - 操作按鈕
- `Tag` - 角色與狀態標籤
- `Message` - 警告訊息
- `Toast` - 操作結果通知

## 🎨 設計特色

### 視覺設計

- 漸層背景（slate-50 → blue-50 → indigo-50）
- 角色顏色標示：
  - 管理員：紅色 (red-500)
  - 照顧者：綠色 (green-500)
  - 家屬：紫色 (purple-500)
- 卡片陰影與邊框
- 響應式設計（RWD）

### 使用者體驗

- 即時搜尋與篩選
- 分頁功能（每頁 10/20/50 筆）
- 排序功能（可按各欄位排序）
- 操作確認提示
- 成功/錯誤訊息通知
- Loading 狀態顯示

## 🔄 操作流程

### 將家屬升級為照顧者

1. 登入管理員帳號
2. 前往「使用者管理」頁面
3. 搜尋或篩選目標使用者
4. 點擊「編輯」按鈕
5. 在對話框中選擇「照顧者」角色
6. 閱讀權限說明與警告訊息
7. 點擊「確認變更」
8. 等待更新完成（顯示成功訊息）

### 將照顧者升級為管理員

1. 登入管理員帳號
2. 前往「使用者管理」頁面
3. 找到目標照顧者
4. 點擊「編輯」按鈕
5. 選擇「管理員」角色
6. 確認權限變更
7. 點擊「確認變更」

### 停用使用者帳號

1. 找到目標使用者
2. 點擊「停用」按鈕（紅色 X 圖示）
3. 帳號立即停用（無法登入）
4. 可隨時點擊「啟用」恢復

## 🚀 部署檢查清單

- ✅ 頁面檔案已建立 (`/frontend/pages/users/index.vue`)
- ✅ 導航選單已包含連結（僅管理員可見）
- ✅ Middleware 權限保護（`allowedRoles: ['admin']`）
- ✅ Firestore 規則已設定（管理員可更新 role）
- ⚠️ **需要部署 Firestore 規則**（如尚未部署）

### 部署 Firestore 規則

```bash
cd /home/jian/Desktop/information_services
pnpm --dir frontend exec firebase deploy --only firestore:rules
```

## 📝 測試建議

### 功能測試

1. ✅ 管理員可以存取 `/users` 頁面
2. ✅ 照顧者/家屬無法存取（被重定向）
3. ✅ 可以載入所有使用者列表
4. ✅ 搜尋功能正常運作
5. ✅ 角色篩選正常運作
6. ✅ 狀態篩選正常運作
7. ✅ 可以成功更新使用者角色
8. ✅ 可以啟用/停用帳號
9. ✅ 更新後資料即時反映

### 權限測試

1. ✅ 管理員可以將家屬改為照顧者
2. ✅ 管理員可以將照顧者改為管理員
3. ✅ 管理員可以將管理員降級為家屬
4. ✅ 角色變更後立即生效
5. ✅ 停用的帳號無法登入
6. ✅ 啟用後可以恢復登入

### UI/UX 測試

1. ✅ 統計卡片數字正確
2. ✅ 角色顏色顯示正確
3. ✅ 分頁功能正常
4. ✅ 排序功能正常
5. ✅ 對話框正常開啟/關閉
6. ✅ Toast 通知正常顯示
7. ✅ Loading 狀態正常

## 🔒 安全注意事項

1. **權限檢查**: 頁面層級與 Firestore 規則雙重保護
2. **角色驗證**: 只有管理員可以變更使用者角色
3. **自我保護**: 建議阻止管理員降級自己（可選實作）
4. **審計日誌**: updatedAt 自動記錄變更時間（可擴充記錄變更者）
5. **帳號停用**: 停用帳號不會刪除資料，可恢復

## 📈 未來擴充建議

1. **批次操作**: 一次選擇多個使用者進行操作
2. **審計日誌**: 記錄誰在何時變更了哪些使用者的角色
3. **Email 通知**: 角色變更時自動發送 Email 通知
4. **進階篩選**: 依註冊時間、最後登入時間等篩選
5. **使用者詳情**: 點擊使用者查看完整資料與操作歷史
6. **匯出功能**: 匯出使用者列表為 Excel/PDF
7. **密碼重設**: 管理員協助使用者重設密碼
8. **多重管理員**: 防止刪除最後一個管理員帳號

---

**建立日期**: 2025/11/10  
**更新日期**: 2025/11/10  
**版本**: 1.0.0
